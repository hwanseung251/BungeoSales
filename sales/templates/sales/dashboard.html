{% extends 'sales/base.html' %}

{% block title %}ëŒ€ì‹œë³´ë“œ - ë¶•ì–´ë¹µ ê´€ë¦¬{% endblock %}
{% block header %}íŒë§¤ ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block extra_css %}
<style>
    .period-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .period-selector a,
    .period-selector button {
        padding: 10px 20px;
        background: #e0e0e0;
        color: #333;
        text-decoration: none;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .period-selector a:hover,
    .period-selector button:hover {
        background: #d0d0d0;
    }

    .period-selector a.active {
        background: #4CAF50;
        color: white;
    }

    .custom-period {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .custom-period input {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .kpi-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }

    .kpi-card h3 {
        font-size: 14px;
        margin-bottom: 10px;
    }

    .kpi-card p {
        font-size: 28px;
        font-weight: bold;
    }

    .section {
        margin: 30px 0;
        padding: 20px;
        background: white;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
    }

    .section h2 {
        font-size: 20px;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 2px solid #4CAF50;
        padding-bottom: 10px;
    }

    .chart-container {
        height: 300px;
        margin-top: 20px;
    }

    .item-stats-table {
        width: 100%;
        border-collapse: collapse;
    }

    .item-stats-table th,
    .item-stats-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    .item-stats-table th {
        background: #4CAF50;
        color: white;
    }

    .item-stats-table tr:hover {
        background: #f5f5f5;
    }
</style>
{% endblock %}

{% block content %}
<div class="period-selector">
    <a href="?period=today" {% if period == 'today' %}class="active"{% endif %}>ì˜¤ëŠ˜</a>
    <a href="?period=week" {% if period == 'week' %}class="active"{% endif %}>ìµœê·¼ 7ì¼</a>
    <a href="?period=month" {% if period == 'month' %}class="active"{% endif %}>ì´ë²ˆ ë‹¬</a>
    <a href="?period=all" {% if period == 'all' %}class="active"{% endif %}>ì „ì²´</a>

    <form method="get" class="custom-period">
        <input type="hidden" name="period" value="custom">
        <input type="date" name="start_date" {% if start_date %}value="{{ start_date|date:'Y-m-d' }}"{% endif %} required>
        <span>~</span>
        <input type="date" name="end_date" {% if end_date %}value="{{ end_date|date:'Y-m-d' }}"{% endif %} required>
        <button type="submit">ì¡°íšŒ</button>
    </form>
</div>

{% if period == 'custom' %}
<div style="margin-bottom: 10px; color: #666;">
    ğŸ“… ê¸°ê°„: {{ start_date|date:'Yë…„ mì›” dì¼' }} ~ {{ end_date|date:'Yë…„ mì›” dì¼' }}
</div>
{% endif %}

<div class="kpi-grid">
    <div class="kpi-card">
        <h3>ì´ ë§¤ì¶œ</h3>
        <p>{{ total_revenue|floatformat:0 }}ì›</p>
    </div>
    <div class="kpi-card">
        <h3>ì´ ì¬ë£Œë¹„</h3>
        <p>{{ total_cost|floatformat:0 }}ì›</p>
    </div>
    <div class="kpi-card">
        <h3>ì´ ìˆœë§ˆì§„</h3>
        <p>{{ total_margin|floatformat:0 }}ì›</p>
    </div>
</div>

<div class="section">
    <h2>í’ˆëª©ë³„ íŒë§¤ í†µê³„</h2>
    <table class="item-stats-table">
        <thead>
            <tr>
                <th>í’ˆëª©</th>
                <th>íŒë§¤ê°œìˆ˜</th>
                <th>ë§¤ì¶œ</th>
            </tr>
        </thead>
        <tbody>
            {% for name, data in item_stats.items %}
            <tr>
                <td>{{ name }}</td>
                <td>{{ data.qty }}ê°œ</td>
                <td>{{ data.revenue|floatformat:0 }}ì›</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="chart-container">
        <canvas id="itemChart"></canvas>
    </div>
</div>

<div class="section">
    <h2>ì‹œê°„ëŒ€ë³„ íŒë§¤ ë¶„í¬ (10ë¶„ ë‹¨ìœ„)</h2>
    <div class="chart-container">
        <canvas id="timeChart"></canvas>
    </div>
</div>

<div class="section">
    <h2>ì¬ë£Œ ì†Œëª¨ëŸ‰</h2>
    <table class="item-stats-table">
        <thead>
            <tr>
                <th>ì¬ë£Œ</th>
                <th>ì‚¬ìš©ëŸ‰ (g)</th>
                <th>ë¹„ìš© (ì›)</th>
            </tr>
        </thead>
        <tbody>
            {% for name, data in ingredient_usage.items %}
            <tr>
                <td>{{ name }}</td>
                <td>{{ data.grams|floatformat:2 }}g</td>
                <td>{{ data.cost|floatformat:0 }}ì›</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
const itemStats = JSON.parse('{{ item_stats|escapejs }}');
const itemNames = Object.keys(itemStats);
const itemQty = itemNames.map(name => itemStats[name].qty);
const itemRevenue = itemNames.map(name => itemStats[name].revenue);

const ctx1 = document.getElementById('itemChart').getContext('2d');
new Chart(ctx1, {
    type: 'doughnut',
    data: {
        labels: itemNames,
        datasets: [{
            label: 'íŒë§¤ê°œìˆ˜',
            data: itemQty,
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

const timeData = JSON.parse('{{ time_data|escapejs }}');
const timeLabels = timeData.map(item => item[0]);
const timeValues = timeData.map(item => item[1]);

const ctx2 = document.getElementById('timeChart').getContext('2d');
new Chart(ctx2, {
    type: 'line',
    data: {
        labels: timeLabels,
        datasets: [{
            label: 'íŒë§¤ê°œìˆ˜',
            data: timeValues,
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            borderColor: 'rgba(76, 175, 80, 1)',
            borderWidth: 2,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>
{% endblock %}
